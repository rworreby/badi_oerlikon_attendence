name: Build and Deploy to Azure

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  RESOURCE_GROUP_NAME: ${{ secrets.RESOURCE_GROUP_NAME }}
  WEB_APP_NAME: ${{ secrets.WEB_APP_NAME }}
  FUNCTION_APP_NAME: ${{ secrets.FUNCTION_APP_NAME }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pylint
    
    - name: Lint with pylint
      run: |
        pylint src/ --disable=all --enable=E
      continue-on-error: true
    
    - name: Run tests
      run: |
        pytest src/tests/ -v
      continue-on-error: true
    
    - name: Build Web App Docker Image
      run: |
        docker build -f docker/Dockerfile.webapp -t ${{ env.REGISTRY_LOGIN_SERVER }}/badi-webapp:${{ github.sha }} .
        docker tag ${{ env.REGISTRY_LOGIN_SERVER }}/badi-webapp:${{ github.sha }} ${{ env.REGISTRY_LOGIN_SERVER }}/badi-webapp:latest
    
    - name: Login to Container Registry
      run: |
        docker login ${{ env.REGISTRY_LOGIN_SERVER }} -u ${{ env.REGISTRY_USERNAME }} -p ${{ env.REGISTRY_PASSWORD }}
    
    - name: Push Web App Image
      run: |
        docker push ${{ env.REGISTRY_LOGIN_SERVER }}/badi-webapp:${{ github.sha }}
        docker push ${{ env.REGISTRY_LOGIN_SERVER }}/badi-webapp:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy Web App
      run: |
        az webapp config container set \
          --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
          --name ${{ env.WEB_APP_NAME }} \
          --docker-custom-image-name ${{ env.REGISTRY_LOGIN_SERVER }}/badi-webapp:latest \
          --docker-registry-server-url https://${{ env.REGISTRY_LOGIN_SERVER }} \
          --docker-registry-server-user ${{ env.REGISTRY_USERNAME }} \
          --docker-registry-server-password ${{ env.REGISTRY_PASSWORD }}
    
    - name: Restart Web App
      run: |
        az webapp restart \
          --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
          --name ${{ env.WEB_APP_NAME }}
    
    - name: Deploy Azure Function
      run: |
        # Package the function app
        cd src/functions
        mkdir -p build
        cp -r crawler_timer build/
        cp requirements.txt build/
        
        # Deploy to Azure
        az functionapp deployment source config-zip \
          --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
          --name ${{ env.FUNCTION_APP_NAME }} \
          --src build.zip
    
    - name: Verify Deployment
      run: |
        echo "Web App URL: https://${{ env.WEB_APP_NAME }}.azurewebsites.net"
        sleep 10
        curl https://${{ env.WEB_APP_NAME }}.azurewebsites.net/health || true
